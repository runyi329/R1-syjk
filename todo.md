# Project TODO

## 已完成功能
- [x] 后端API开发（用户管理、积分管理、商品管理、订单管理）
- [x] 用户中心页面
- [x] 兑换商城页面
- [x] 管理员后台页面
- [x] 权限控制系统

## 待修复问题
- [x] 移动端导航：登录/注册按钮在手机上不可见（hidden sm:flex导致）
- [x] OAuth登录404错误：经测试登录功能正常，之前是因为未登录状态
- [x] 移动端布局优化：所有页面已优先考虑手机版布局
- [x] 管理员后台移动端适配（用户管理已优化）
- [x] 商品管理页面移动端优化
- [x] 订单管理页面移动端优化
- [x] 用户中心页面移动端优化
- [x] 兑换商城页面移动端优化

### 新问题
- [x] 修复登录注册按钮的04错误（用户点击后显示404） - 已添加/api/oauth/login路由

## 待修复
- [x] OAuth登录返回{"message":null}错误 - 开发环境需要配置回调URL，发布后自动解决

## 新功能需求
- [x] 用户注册流程：新用户首次登录后必须设置用户名
- [x] 创建注册页面，让用户输入用户名
- [x] 后端API：添加更新用户名的接口
- [x] 首次登录检测：如果用户名为空，强制跳转到注册页面
- [x] 未注册用户无法访问其他页面

## 待解决问题
- [x] 开发环境OAuth登录404：已添加登录说明弹窗，告知用户发布后才能使用OAuth登录

## 紧急修复
- [x] 正式域名OAuth登录：移除登录说明对话框，在生产环境直接跳转OAuth登录

## 新增功能
- [x] 测试登录功能：添加测试登录按钮，无需OAuth即可快速登录
- [x] 测试登录API：创建/api/test-login端点，自动创建或登录测试账号
- [x] 首页测试登录按钮：在登录按钮旁边添加“测试登录”选项

## 紧急问题
- [x] 开发环境网站显示Not Found错误 - 已解决，开发环境正常
- [x] 正式域名(runyi.manus.space)显示Not Found - 修复测试登录session错误，使用SDK创建session token

## 待解决
- [x] 检查点卡片只显示回滚按钮 - 正在创建新检查点

## 系统状态
- 测试登录功能：正常工作
- OAuth登录：正常工作
- 用户注册流程：正常工作
- 移动端适配：已完成

## 紧急问题
- [x] runyi.manus.space网站完全无法访问 - 开发环境正常，需要发布最新版本

## 新功能需求 - 彩票分析系统
- [x] 创建彩票分析页面（/lottery）
- [x] 支持多种彩票类型：双色球、大乐透、福彩3D、排列5
- [x] 中奖概率计算器：计算各等级奖项的中奖概率
- [x] 期望收益分析：计算投注金额与期望回报
- [x] 历史数据统计：显示历史开奖号码的频率分布（模拟数据）
- [x] 号码走势分析：图表展示号码出现趋势（模拟数据）
- [x] 移动端适配：确保所有功能在手机上完美显示

## 新功能需求 - 账户余额显示优化
- [x] 修改标题：将“USDT 积分余额”和“当前可用余额”改为“总资产”
- [x] 添加隐藏功能：添加小眼睛图标，点击可隐藏/显示金额（显示为星号）
- [x] 优化布局：将USDT单位放在金额后面同一行，不另起一行

## 样式微调 - USDT单位显示
- [x] 调整USDT单位样式：改为更小的白色字体，与之前版本保持一致

## 新功能需求 - 充值提现功能
- [x] 创建充值页面（/deposit）
- [x] 显示收款地址（可复制）
- [x] 显示收款二维码
- [x] 网络选择（Aptos、Ethereum、BSC、Polygon）
- [x] 显示最小充值金额
- [x] 显示到账时间提示
- [x] 创建提现页面（/withdraw）
- [x] 输入提现地址
- [x] 输入提现金额（包含“全部”按钮）
- [x] 选择提现网络
- [x] 显示手续费和到账时间
- [x] 添加充值/提现入口到用户中心
- [x] 移动端完全适配

## 新功能需求 - 充值提现流程管理
### 数据库设计
- [x] 创建充值订单表（deposits）
- [x] 创建提现订单表（withdrawals）
- [x] 创建钱包地址表（wallet_addresses）

### 客户端功能
- [x] 充值记录查看（状态：待确认/已到账/失败）
- [x] 提现记录查看（状态：待审核/处理中/已完成/已拒绝）
- [x] 钱包地址管理页面（绑定、查看、删除）
- [x] 钱包地址绑定功能（地址、网络、二维码上传）
- [x] 提现时选择已绑定的钱包地址
- [x] 充值/提现订单详情查看

### 管理员功能
- [x] 充值订单管理页面（查看所有充值订单）
- [x] 充值订单审核（确认到账/标记失败）
- [x] 充值订单编辑（修改金额、状态、备注）
- [x] 提现订单管理页面（查看所有提现订单）
- [x] 提现订单审核（批准/拒绝）
- [x] 提现订单处理（标记已完成）
- [x] 钱包地址审核（批准/拒绝客户绑定的地址）
- [x] 订单搜索和筛选功能（基础版）

### API开发
- [x] 充值订单CRUD API
- [x] 提现订单CRUD API
- [x] 钱包地址CRUD API
- [x] 订单状态更新API
- [x] 管理员审核API

## 新功能需求 - 百家乐模拟投注
### 功能设计
- [x] 模拟局数选择：100/500/1000/5000/10000/1000000局
- [x] 带入资金输入：1000元 - 10,000,000元
- [x] 投注策略：马丁格尔倍投法（500元起注，输了翻倍，赢了重置）
- [x] 最大单注限制：2,000,000元
- [x] 随机选择下注庄或闲
- [x] 庄赢5%，闲赢不抽，和局退回
- [x] 资金不足时提前终止模拟

### 统计数据
- [x] 初始资金、限红、实际投注局数
- [x] 开庄/开闲/开和的局数和比例
- [x] 庄最长连赢/连输（和局不算断）
- [x] 闲最长连赢/连输（和局不算断）
- [x] 最终盈亏金额和盈亏率
- [x] 资金曲线图（显示资金变化趋势）
- [x] 投注历史记录（前100局详情）

### UI实现
- [x] 模拟设置面板（局数选择、资金输入）
- [x] 开始模拟按钮和进度显示
- [x] 统计结果展示卡片
- [x] 资金曲线图表（使用recharts）
- [x] 移动端完全适配

## 百家乐模拟投注优化
- [x] 添加进度条：圆形筹码图案，显示实时百分比，平均等待2-3秒
- [x] 添加快捷金额选项：10000/50000/100000/200000/500000/1000000
- [x] 颜色调整：盈利改为红色，亏损改为绿色
- [x] 优化资金曲线图颜色，避免与背景重叠
- [x] 添加“此次共投注X局”总览统计
- [x] 每个统计数据旁边显示理论期望值
- [x] 显示实际值与期望值的偏差百分比

## 百家乐模拟投注进一步优化
- [x] 优化图表坐标轴颜色：X轴和Y轴的线条和文字使用更明显的颜色（#94a3b8）
- [x] 添加最小投注金额统计
- [x] 添加最大投注金额统计
- [x] 添加平均投注金额统计
- [x] 添加平均每局盈亏统计
- [x] 添加资金最低值统计
- [x] 添加资金最高值统计
- [x] 投注历史默认显示前100局
- [x] 添加“查看全部历史”按钮（超过100局时显示）
- [x] 点击按钮展开显示所有投注记录

## 百家乐模拟投注细节优化
- [x] 资金最高值优化：显示相对本金的盈利金额和获利百分比
- [x] 平均每局盈亏优化：添加理论期望亏损值（¥-1.17）和偏差
- [x] 新增总投注金额统计：显示总投注金额和流水倍数（总投注/本金）
- [x] 颜色调整：连赢改为红色，连输改为绿色

## 百家乐模拟投注 - 继续投注功能
- [x] 添加“继续投注”按钮（仅在资金未归零时显示）
- [x] 继续投注局数与初始局数一致
- [x] 多轮投注数据合并展示（累计统计）
- [x] 资金曲线图分段显示不同颜色（第一轮橙色，第二轮蓝色，第三轮紫色等）
- [x] 资金曲线添加渐变填充效果（从曲线到X轴，透明度逐渐降低）
- [x] 不同轮次使用不同渐变颜色
- [x] 投注历史标注轮次信息（通过合并history实现）

## Bug修复 - 资金曲线图不显示
- [x] 诊断资金曲线图不显示的原因（多个Line组件使用不同data导致冲突）
- [x] 修复图表数据绑定问题（简化为单个Line组件）
- [x] 确保单轮和多轮投注的曲线都能正常显示
- [x] 测试渐变填充效果

## 投注历史显示优化
- [x] 修改投注历史默认显示为最后100局（使用slice(-100)）
- [x] 点击“查看全部”后显示所有历史记录

## Bug修复 - 投注历史局数显示错误
- [x] 修复投注历史表格中的局数显示，确保显示真实的局数编号
- [x] 例如：1000局中的最后100局应显示901-1000，而不是1-100
- [x] 验证余额显示与最终余额一致（修改为保留所有历史记录）

## 新增统计数据 - 玩家连赢连输
- [x] 添加玩家最长连赢局数统计（庄闲都算赢，和局不算断）
- [x] 添加玩家最长连输局数统计（和局不算断）
- [x] 在模拟结果中显示这两个统计数据
- [ ] 附带期望值对比（暂无明确理论期望值）

## 性能优化 - 移除100万局模拟选项
- [x] 移除100万局模拟按钮，避免超大数据量导致页面卡顿
- [x] 保留最高到1万局的模拟选项

## UI优化和文案修改
- [x] 移动端导航栏取消固定定位，随页面滚动消失（使用md:sticky仅在桌面端固定）
- [x] 将“积分流水”改为“资金流水”
- [x] 将公司名称改为“数金研投”（UserCenter、Shop、Lottery页面）

## 品牌名称统一
- [x] 查找所有页面中的公司名称（澳门润仪投资、RUNYI INVESTMENT等）
- [x] 将首页（Home.tsx）的公司名称改为“数金研投”
- [x] 将所有其他页面的公司名称改为“数金研投”
- [x] 确保所有页面品牌形象一致
- [x] 更新investment-portal-content.json数据文件中的公司名称
- [x] 更新轮盘分析页面（RouletteAnalysis.tsx）底部公司名称
- [x] 更新足球分析页面（FootballAnalysis.tsx）底部公司名称

## Logo设计与替换
- [x] 设计“数金研投”专业Logo（金色主题，融合金融投资元素）
- [x] 生成Logo图片（logo.png, logo-icon.png, logo-256.png）
- [x] 将Logo保存到client/public/目录
- [x] 替换首页（Home.tsx）的R1占位符为Logo图片
- [x] 替换百家乐分析页面的Logo
- [x] 替换轮盘分析页面的Logo
- [x] 替换足球分析页面的Logo
- [x] 替换用户中心页面的Logo
- [x] 替换兑换商城页面的Logo
- [x] 替换管理员后台页面的Logo
- [x] 测试所有页面Logo显示效果

## 项目名称修改
- [x] 将项目卡片显示名称从“百家乐投注类型庄家优势数据分析”改为“数金研投”
- [x] 创建新的检查点生成新卡片

## 退出登录功能
- [x] 在首页右上角添加退出登录按钮
- [x] 实现退出登录逻辑（清除登录状态）
- [x] 退出登录后返回首页未登录状态
- [x] 测试退出登录功能

## 删除"管理员"文本
- [x] 查找所有充值和提现页面中的"管理员"文本
- [x] 删除充值页面中的"管理员充值"改为"充值"
- [x] 删除提现页面中的"管理员提现"改为"提现"
- [x] 删除钱包地址页面中的"管理员"相关文本
- [x] 测试验证修改效果

## 修复充值和提现页面
- [ ] 修复默认备注问题 - 不填写备注时不显示任何提示
- [x] 在充值页面添加后退按钮
- [x] 在提现页面添加后退按钮
- [x] 在充值历史中添加交易状态筛选功能
- [x] 在提现历史中添加交易状态筛选功能
- [x] 测试验证所有修改

## 修复资金流水记录文本
- [x] 修复后端points.ts中的"管理员充值"自动生成文本
- [x] 修改充值流水记录为"充值 X USDT"（不显示"管理员"）
- [x] 修改提现流水记录为"提现 X USDT"（不显示"管理员"）
- [x] 测试验证修改效果

## 为UserCenter页面添加交易状态筛选
- [x] 在UserCenter页面的充值历史中添加状态筛选按钮
- [x] 在UserCenter页面的提现历史中添加状态筛选按钮
- [x] 实现筛选逻辑，支持按状态过滤交易记录
- [x] 测试验证筛选功能正常工作

## Bug修复 - 充值历史不显示订单数据
- [x] 查询数据库中的充值记录，确认数据是否正确保存
- [x] 检查前端getMyDeposits API是否正确获取用户的充值记录
- [x] 在deposits.ts中添加adminDeposit API，为管理员充值创建订单
- [x] 修改AdminDashboard使用新的adminDeposit API
- [ ] 测试新的充值功能是否正常工作

## 修复充值历史显示问题
- [x] 修改Deposit.tsx，认证备注只在有内容时显示（默认不显示）
- [x] 创建数据迁移脚本，将pointTransactions中的充值记录转换为deposit订单
- [x] 执行迁移脚本，将历史充值记录导入到deposits表
- [x] 测试验证所有充值记录都显示在充值历史中

## 清空自动生成的备注内容
- [x] 清空所有deposits表中的自动生成adminNotes
- [x] 确保备注框只在管理员手动填写时显示
- [x] 验证充值历史中不再显示中英文混合内容

## 清空资金流水记录中的自动生成内容
- [x] 清空pointTransactions表中所有自动生成的notes（Deposit、充值、管理员、提现等）
- [x] 保留管理员手动填写的备注内容
- [x] 验证资金流水记录中不再显示中英文混合内容

## 移除资金流水记录中的"无备注"显示
- [x] 修改UserCenter.tsx，移除"无备注"文本显示
- [x] 当notes为空时完全不显示任何内容
- [x] 验证资金流水记录显示效果

## 在充值/提现历史中添加备注显示
- [x] 在UserCenter充值历史中添加adminNotes显示（只在有内容时显示）
- [x] 在UserCenter提现历史中添加adminNotes显示（只在有内容时显示）
- [x] 验证Deposit.tsx和Withdraw.tsx中的备注显示逻辑已正确
- [x] 确保所有地方的备注显示逻辑一致

## 清空充值历史中的标签
- [x] 清空deposits表中network字段中的"Admin 岗位"和"Migration 岗位"
- [x] 将这些记录的network字段设置为"Sui"
- [x] 验证修改成功

## 修复Deposit.tsx中的map函数bug
- [x] 修复第284行的双箭头函数问题
- [x] 将`(deposit) => () => (`改为`(deposit) => (`
- [x] 验证TypeScript编译通过（0 errors）
- [x] 优化充值历史的渲染性能

## 修改充值历史的显示逻辑
- [x] 隐藏Deposit.tsx中的network字段显示
- [x] 修改CardDescription只显示adminNotes（当有备注时）
- [x] 完全隐藏没有备注的充值记录的描述部分
- [x] 与资金流水记录的显示逻辑保持一致

## 修改UserCenter中充值历史的显示逻辑
- [x] 隐藏UserCenter.tsx中充值历史的network字段显示
- [x] 移除"Sui 网络"等标签的显示
- [x] 只保留金额、时间和adminNotes
- [x] 与Deposit.tsx中的充值历史显示逻辑保持一致


## 移除所有页面的sticky定位
- [x] 移除Home.tsx中的sticky定位
- [x] 移除BaccaratAnalysis.tsx中的sticky定位
- [x] 移除RouletteAnalysis.tsx中的sticky定位
- [x] 移除FootballAnalysis.tsx中的sticky定位
- [x] 移除PokerAnalysis.tsx中的sticky定位
- [x] 移除UserCenter.tsx中的md:sticky定位
- [x] 移除Shop.tsx中的md:sticky定位
- [x] 移除AdminDashboard.tsx中的sticky定位
- [x] 移除Lottery.tsx中的md:sticky定位
- [x] 移除Deposit.tsx中的sticky定位
- [x] 移除Withdraw.tsx中的sticky定位
- [x] 移除WalletAddresses.tsx中的sticky定位
- [x] 验证TypeScript编译通过（0 errors）
- [x] 所有页面header现在随页面滚动而上下移动


## 添加返回顶部悬浮按钮
- [x] 创建ScrollToTop组件
- [x] 在Home页面添加组件
- [x] 在BaccaratAnalysis页面添加组件
- [x] 在RouletteAnalysis页面添加组件
- [x] 在FootballAnalysis页面添加组件
- [x] 在PokerAnalysis页面添加组件
- [x] 在UserCenter页面添加组件
- [x] 在Shop页面添加组件
- [x] 在Lottery页面添加组件
- [x] 在Deposit页面添加组件
- [x] 在Withdraw页面添加组件
- [x] 在WalletAddresses页面添加组件
- [x] 验证所有页面的悬浮按钮正常工作


## 添加移动端固定底部导航栏
- [x] 创建MobileBottomNav组件
- [x] 在App.tsx中全局添加底部导航
- [x] 为所有页面添加下方padding（pb-20 md:pb-0）
- [x] 验证TypeScript编译通过


## 修复登出功能
- [x] 查找登出 API的实现
- [x] 检查MobileBottomNav中的登出逻辑
- [x] 修复登出后的缓存清理
- [x] 验证useAuth hook的登出实现已正确


## 实现用户名+密码注册功能
- [x] 实现后端注册API（users.register）
- [x] 实现后端登录API（users.loginWithPassword）
- [x] 修改数据库schema，添加username、passwordHash、registerMethod字段
- [x] 创建注册页面组件（Register.tsx）
- [x] 修复首页个人中心按钮标签
- [x] 优化首页导航栏（未登录显示注册/登录，登录后显示个人中心/登出）
- [x] 添加用户名+密码登录对话框
- [x] 编写vitest测试（11个测试全部通过）
- [x] 测试注册和登出流程


## 登录安全防护功能
- [x] 修改users表，添加account_locked字段
- [x] 创建 loginAttempts表，记录登录失败尝试
- [x] 创建 captchas表，存储滑动拼图验证码
- [x] 实现后端登录失败检查函数
- [x] 实现后端账户锁定/解锁函数
- [x] 实现后端滑动拼图验证码生成函数
- [x] 实现后端验证码验证函数
- [x] 实现后端登录失败检查API（users.loginWithPassword改进）
- [x] 实现后端验证码生成API（users.generateCaptcha）
- [x] 实现后端账户解锁API（users.unlockAccount）
- [x] 创建滑动拼图验证码组件（PuzzleCaptcha.tsx）
- [x] 优化首页登录对话框，集成验证码和失败次数显示
- [x] 编写单元测试（18个测试全部通过）
- [x] 测试登录失败次数限制功能
- [x] 测试滑动拼图验证码功能
- [x] 测试账户锁定和解锁流程


## Bug修复 - 登出功能不工作
- [x] 诊断登出API问题
- [x] 修复前端登出逻辑（改为TRPC调用）
- [x] 测试登出功能是否正常
- [x] 确保登出后能正确返回首页未登录状态


## 功能优化 - 移除OAuth登录
- [x] 从首页导航栏移除OAuth登录按钮
- [x] 只保留用户名+密码登录
- [x] 测试登录和注册功能


## 忽记密码功能
- [x] 修改users表，添加email字段
- [x] 创建 passwordResets表，存储密码重置请求
- [x] 配置邀件服务（Nodemailer + Gmail）
- [x] 实现后端API：发送验证码（users.sendPasswordResetCode）
- [x] 实现后端API：验证码验证（users.verifyPasswordResetCode）
- [x] 实现后端API：重置密码（users.resetPassword）
- [x] 修改Register.tsx，添加邮箱字段（可选）
- [x] 创建 ForgotPassword.tsx页面
- [x] 在App.tsx中添加忽记密码路由
- [x] 在登录对话框中添加"忽记密码"链接
- [x] 编写单元测试验证邮件发送和密码重置功能（15个测试全部通过）
- [x] 测试整个忽记密码流程

## UI改进 - 个人中心返回按钮
- [x] 为UserCenter页面添加返回首页按钮
- [x] 测试返回按钮功能

## UI优化 - 个人中心功能区整合
- [x] 将总资产、账户状态、账户信息三个功能区整合为两个框
- [x] 账户信息只保留用户名和VIP等级
- [x] 实现VIP等级计算逻辑（根据总资产：1万VIP1、5万VIP2、10万VIP3、20万VIP4、50万VIP5）
- [x] 测试VIP等级显示和响应式设计
## UI优化 - VIP升级进度条
- [x] 在账户信息卡片中添加VIP升级进度条
- [x] 显示距离下一个等级还需充值多少USDT
- [x] 显示当前等级和下一个等级的信息
- [x] 测试进度条在不同的VIP等级的显示效果

## UI优化 - 导航栏用户信息显示
- [x] 在导航栏显示当前登录用户的昵称
- [x] 在导航栏显示用户的VIP等级
- [x] 设计合理的排版方案（用户信息与个人中心/登出按钮的布局）
- [x] 测试不同VIP等级的显示效果
- [x] 测试响应式设计（移动端和桌面端）

## UI优化 - 后台链接位置调整
- [x] 从导航栏移除后台链接按钮
- [x] 在页面底部品牧logo上添加后台链接
- [x] 测试后台链接功能
- [x] 提供管理员密码设置指导文档

## 管理员功能 - 账户和密码管理
- [x] 创建管理员账户（用户名：runyi，密码：831118）
- [x] 在后台管理界面添加修改密码功能
- [x] 测试管理员账户登录
- [x] 测试修改密码功能
